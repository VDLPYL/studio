<!DOCTYPE html>
<html>
<head>
  <title>VDLPYL Studio - Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    #mensajes { margin-top: 20px; }
    .mensaje { border: 1px solid #ccc; padding: 10px; margin: 5px 0; }
  </style>
</head>
<body style="display: none;">
  <h1>VDLPYL Studio - Chat</h1>

  <p>Enviar mensaje a: <input type="text" id="receptor" placeholder="Nombre de usuario del receptor"></p>
  <textarea id="mensaje" placeholder="Escribe tu mensaje..."></textarea><br>
  <button onclick="enviarMensaje()">Enviar</button>

  <h2>Mensajes</h2>
  <div id="mensajes"></div>

  <script>
    // Configuración de Firebase
var firebaseConfig = {
      apiKey: "AIzaSyCnlZcZTwdMhw1-izQ5JzHTp7zGN3LByO8",
      authDomain: "vdlpyl-studio.firebaseapp.com",
      projectId: "vdlpyl-studio",
      storageBucket: "vdlpyl-studio.appspot.com",
      messagingSenderId: "248043788120",
      appId: "1:248043788120:web:045b3cbc98611f3969772d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let usuario = "";

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        db.collection("usuarios").doc(user.uid).get().then(doc => {
          if (doc.exists) {
            usuario = doc.data().nombre;

            db.collection("usuarios_aprobados").doc(usuario).get().then(doc => {
              if (doc.exists) {
                document.body.style.display = "block";
                cargarMensajes();
              } else {
                alert("Tu acceso no ha sido aprobado por el administrador.");
                window.location.href = "login.html";
              }
            });

          } else {
            alert("No se encontró tu nombre de usuario.");
            window.location.href = "login.html";
          }
        });
      } else {
        alert("Debes iniciar sesión.");
        window.location.href = "login.html";
      }
    });

    function enviarMensaje() {
      const receptor = document.getElementById("receptor").value.trim();
      const texto = document.getElementById("mensaje").value.trim();

      if (!receptor || !texto) {
        alert("Debes completar ambos campos.");
        return;
      }

      // Verificar si ya ha enviado 10 mensajes
      db.collection("mensajes")
        .where("remitente", "==", usuario)
        .get()
        .then(snapshot => {
          if (snapshot.size >= 10) {
            alert("Has alcanzado el límite de 10 mensajes.");
          } else {
            db.collection("mensajes").add({
              remitente: usuario,
              receptor: receptor,
              texto: texto,
              fecha: new Date(),
              remitenteConfirmaEliminacion: false,
              receptorConfirmaEliminacion: false
            });
            document.getElementById("mensaje").value = "";
          }
        });
    }

    function cargarMensajes() {
      db.collection("mensajes").orderBy("fecha", "desc").onSnapshot(snapshot => {
        const contenedor = document.getElementById("mensajes");
        contenedor.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.remitente === usuario || data.receptor === usuario) {
            const div = document.createElement("div");
            div.className = "mensaje";
            div.innerHTML = `
              <strong>${data.remitente}</strong> → <strong>${data.receptor}</strong>: ${data.texto}
              <br><small>${data.fecha.toDate().toLocaleString()}</small>
              <br><button onclick="confirmarEliminacion('${doc.id}')">Solicitar eliminación</button>
            `;
            contenedor.appendChild(div);
          }
        });
      });
    }

    function confirmarEliminacion(idMensaje) {
      db.collection("mensajes").doc(idMensaje).get().then(doc => {
        const data = doc.data();
        if (data.remitente === usuario) {
          db.collection("mensajes").doc(idMensaje).update({
            remitenteConfirmaEliminacion: true
          });
        } else if (data.receptor === usuario) {
          db.collection("mensajes").doc(idMensaje).update({
            receptorConfirmaEliminacion: true
          });
        }

        // Verificar si ambas partes confirmaron
        if (data.remitenteConfirmaEliminacion && data.receptorConfirmaEliminacion) {
          db.collection("mensajes").doc(idMensaje).delete();
        }
      });
    }
  </script>
</body>
</html>
