<!DOCTYPE html>
<html>
<head>
  <title>VDLPYL-sdc</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <h1>Servicio de carrera</h1>

  <div>
    <label>Tu nombre de usuario:</label>
    <input type="text" id="usuario" placeholder="Ej: Gerardo">
    <br><br>
    <label>Enviar mensaje a:</label>
    <input type="text" id="receptor" placeholder="Ej: Maria">
    <br><br>
    <textarea id="mensaje" placeholder="Escribe tu mensaje"></textarea>
    <br>
    <button onclick="enviarMensaje()">Enviar</button>
  </div>

  <h3>Mensajes:</h3>
  <div id="mensajes"></div>






  <script>
    // Configuración de Firebase
    var firebaseConfig = {
      apiKey: "AIzaSyCnlZcZTwdMhw1-izQ5JzHTp7zGN3LByO8",
      authDomain: "vdlpyl-studio.firebaseapp.com",
      projectId: "vdlpyl-studio",
      storageBucket: "vdlpyl-studio.appspot.com",
      messagingSenderId: "248043788120",
      appId: "1:248043788120:web:045b3cbc98611f3969772d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let usuario = "";





document.getElementById("usuario").addEventListener("change", (e) => {
  const nombreIngresado = e.target.value.trim();

  db.collection("usuarios_autorizados")
    .where("nombre", "==", nombreIngresado)
    .get()
    .then((querySnapshot) => {
      if (!querySnapshot.empty) {
        usuario = nombreIngresado;
        cargarMensajes();
      } else {
        alert("No estás autorizado para enviar mensajes. Solicita acceso primero.");
        document.getElementById("usuario").value = "";
      }
    });
});



    function enviarMensaje() {
      const receptor = document.getElementById("receptor").value;
      const texto = document.getElementById("mensaje").value;

      if (!usuario || !receptor || !texto) {
        alert("Completa todos los campos.");
        return;
      }

      // Contar los mensajes que ha enviado el usuario
      db.collection("mensajes")
        .where("remitente", "==", usuario)
        .get()
        .then((snap) => {
          if (snap.size >= 10) {
            alert("Solo puedes enviar hasta 10 mensajes.");
          } else {
            db.collection("mensajes").add({
              remitente: usuario,
              receptor: receptor,
              texto: texto,
              fecha: firebase.firestore.FieldValue.serverTimestamp(),
              confirmacionBorrado: []
            }).then(() => {
              document.getElementById("mensaje").value = "";
            });
          }
        });
    }






    function cargarMensajes() {
      db.collection("mensajes")
        .orderBy("fecha")
        .onSnapshot(snapshot => {
          const contenedor = document.getElementById("mensajes");
          contenedor.innerHTML = "";

          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.remitente === usuario || data.receptor === usuario) {
              const fecha = data.fecha?.toDate?.();
              const fechaTexto = fecha ? `${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}` : "Fecha desconocida";

              let estado = "";
              const confirmaciones = data.confirmacionBorrado || [];
              if (confirmaciones.length === 1) {
                estado = "<em style='color: orange;'>Eliminación pendiente</em>";
              } else if (confirmaciones.length === 2) {
                estado = "<em style='color: red;'>Listo para eliminar</em>";
              }





const div = document.createElement("div");
div.innerHTML = `
  <strong>${data.remitente}</strong> → <strong>${data.receptor}</strong>: ${data.texto}<br>
  <small>${fechaTexto}</small><br>
  ${estado}
  <br>
  <button onclick="intentarEliminarMensaje('${doc.id}', '${usuario}', ['${data.remitente}', '${data.receptor}'])">
    Eliminar
  </button>
`;
contenedor.appendChild(div);



            }
          });
        });
    }


function intentarEliminarMensaje(id, usuario, participantes) {
  db.collection("mensajes").doc(id).get().then(doc => {
    const data = doc.data();
    const confirmaciones = data.confirmacionBorrado || [];

    if (confirmaciones.includes(usuario)) {
      alert("Ya solicitaste eliminar este mensaje.");
      return;
    }

    confirmaciones.push(usuario);

    if (confirmaciones.length === 2) {
      // Ambos confirmaron: eliminar el mensaje
      db.collection("mensajes").doc(id).delete();
    } else {
      // Solo uno ha confirmado, guardar la confirmación
      db.collection("mensajes").doc(id).update({
        confirmacionBorrado: confirmaciones
      });
    }
  });
}


  </script>

  <hr>
  <h6><a href="https://VDLPYL.github.io/VDLPYL">VDLPYL</a></h6>
</body>
</html>
